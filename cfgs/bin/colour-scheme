#!/usr/bin/env sh
COLOUR_FILE="$HOME/.config/colourscheme"

printhelp () {
    echo "$0 {light|dark}"
    exit 1;
}

nvim_command() {
    echo "[0,0,\"vim_command\",[\"$2\"]]" | json2msgpack | nc -U "$1" 2> /dev/null
}

nvim_all_command() {
    for nvim in /tmp/nvim*/0; do
        nvim_command "$nvim" "$1"
    done
}

wallpaper_dark() {
    WORKDIR="$HOME/.local/share/unsplash/dark"
    DATE=$(date +%s)
    SCREEN_0="$WORKDIR/screen0-$DATE"
    SCREEN_1="$WORKDIR/screen1-$DATE"
    rm -r "$WORKDIR"
    mkdir -p "$WORKDIR"
    wget -O "$SCREEN_0.jpg" -q https://source.unsplash.com/random/2560x1440
    wget -O "$SCREEN_1.jpg" -q https://source.unsplash.com/random/1080x1920
    convert "$SCREEN_0.jpg" -colorspace gray "$SCREEN_0-convert.jpg"
    convert "$SCREEN_1.jpg" -colorspace gray "$SCREEN_1-convert.jpg"
    nitrogen --head=0 --set-scaled "$SCREEN_0-convert.jpg" 2> /dev/null
    nitrogen --head=1 --set-scaled "$SCREEN_1-convert.jpg" 2> /dev/null
}

wallpaper_light() {
    WORKDIR="$HOME/.local/share/unsplash/light"
    DATE=$(date +%s)
    SCREEN_0="$WORKDIR/screen0-$DATE"
    SCREEN_1="$WORKDIR/screen1-$DATE"
    rm -r "$WORKDIR"
    mkdir -p "$WORKDIR"
    wget -O "$SCREEN_0.jpg" -q https://source.unsplash.com/random/2560x1440
    wget -O "$SCREEN_1.jpg" -q https://source.unsplash.com/random/1080x1920
    nitrogen --head=0 --set-scaled "$SCREEN_0.jpg" 2> /dev/null
    nitrogen --head=1 --set-scaled "$SCREEN_1.jpg" 2> /dev/null
}

if [ $# -ne 1 ]; then
    printhelp
else
    case "$1" in
        dark)
            if [ -e "$COLOUR_FILE" ] && [ "$(cat "$COLOUR_FILE")" = "dark" ]; then exit 0; fi
            echo "dark" > "$COLOUR_FILE"
            cp --no-preserve=mode "$HOME/.config/termite/config-dark" "$HOME/.config/termite/config"
            killall -USR1 termite
            nvim_all_command "set background=dark"
            xfconf-query -c xsettings -p /Net/ThemeName -s "Arc-Dark"
            wallpaper_dark
            ;;
        light)
            if [ -e "$COLOUR_FILE" ] && [ "$(cat "$COLOUR_FILE")" = "light" ]; then exit 0; fi
            echo "light" > "$COLOUR_FILE"
            cp --no-preserve=mode "$HOME/.config/termite/config-light" "$HOME/.config/termite/config"
            killall -USR1 termite
            nvim_all_command "set background=light"
            xfconf-query -c xsettings -p /Net/ThemeName -s "Arc-Darker"
            wallpaper_light
            ;;
        *)
            printhelp
    esac
fi
